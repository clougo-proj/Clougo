# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

variables:
  isMain: $[eq(variables['Build.SourceBranch'], 'refs/heads/master')]

trigger:
- master

jobs:
  - job: build
    timeoutInMinutes: 5
    pool:
      vmImage: 'Ubuntu-latest'

    steps:
    - checkout: self
      persistCredentials: true
      clean: true

    # - task: NodeTool@0
    #   inputs:
    #     versionSpec: '12.x'
    #   displayName: 'Install Node.js'

    # - script: npm install eslint
    #   displayName: 'Install ESLint'

    - script: |
        npm install
        npm run-script eslint
      displayName: 'Run ESLint'

    - script: npm run-script pkut
      displayName: 'Pack unit tests'

    - script: npm run-script test
      displayName: 'Run unit tests'

    # - task: PublishBuildArtifacts@1
    #   inputs:
    #     pathToPublish: '$(Build.SourcesDirectory)/generated/*'
    #     artifactName: 'generated'
    - publish: generated
      artifact: generated

  - job: deploy
    dependsOn: build
    condition: and(succeeded(), eq(variables.isMain, true))
    pool:
      vmImage: 'Ubuntu-latest'

    steps:
    - checkout: self
      persistCredentials: true
      clean: true

    # - task: NodeTool@0
    #   inputs:
    #     versionSpec: '12.x'
    #   displayName: 'Install Node.js'

    # - script: npm run-script pkut
    #   displayName: 'Pack unit tests'

    - task: DownloadPipelineArtifact@2
      inputs:
        artifact: 'generated'
        path: '$(System.DefaultWorkingDirectory)/generated/'

    # - download: current
    #   artifact: generated
    #   path: '$(System.DefaultWorkingDirectory)/generated'

    - script: |
        pwd
        ls -l
        ls -l generated

    - script: npm run-script test
      displayName: 'Run unit tests'
